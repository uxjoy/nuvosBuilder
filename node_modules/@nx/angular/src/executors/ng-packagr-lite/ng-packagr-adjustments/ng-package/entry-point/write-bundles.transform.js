"use strict";
/**
 * Adapted from the original ng-packagr.
 *
 * Changes made:
 * - Removed bundling altogether.
 * - Write the ESM2022 outputs to the file system.
 * - Fake the FESM2022 outputs pointing them to the ESM2022 outputs.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.writeBundlesTransform = void 0;
const build_graph_1 = require("ng-packagr/lib/graph/build-graph");
const transform_1 = require("ng-packagr/lib/graph/transform");
const nodes_1 = require("ng-packagr/lib/ng-package/nodes");
const package_1 = require("ng-packagr/lib/ng-package/package");
const promises_1 = require("node:fs/promises");
const node_path_1 = require("node:path");
const entry_point_1 = require("./entry-point");
const writeBundlesTransform = (_options) => (0, transform_1.transformFromPromise)(async (graph) => {
    const updatedGraph = new build_graph_1.BuildGraph();
    for (const entry of graph.entries()) {
        if ((0, nodes_1.isEntryPoint)(entry)) {
            const entryPoint = toCustomNgEntryPoint(entry.data.entryPoint);
            entry.data.entryPoint = entryPoint;
            entry.data.destinationFiles = entryPoint.destinationFiles;
            for (const [path, outputCache] of entry.cache.outputCache.entries()) {
                // write the outputs to the file system
                await (0, promises_1.mkdir)((0, node_path_1.dirname)(path), { recursive: true });
                await (0, promises_1.writeFile)(path, outputCache.content);
            }
        }
        else if ((0, nodes_1.isPackage)(entry)) {
            entry.data = new package_1.NgPackage(entry.data.src, toCustomNgEntryPoint(entry.data.primary), entry.data.secondaries.map((secondary) => toCustomNgEntryPoint(secondary)));
        }
        updatedGraph.put(entry);
    }
    return updatedGraph;
});
exports.writeBundlesTransform = writeBundlesTransform;
function toCustomNgEntryPoint(entryPoint) {
    return new entry_point_1.NgEntryPoint(entryPoint.packageJson, entryPoint.ngPackageJson, entryPoint.basePath, 
    // @ts-expect-error this is a TS private property, but it can be accessed at runtime
    entryPoint.secondaryData);
}
